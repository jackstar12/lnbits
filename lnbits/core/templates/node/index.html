{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<div class="row q-col-gutter-md justify-center">
  <div class="col q-gutter-y-md">
    <q-card>
      <div class="q-pa-md">
        <div class="q-gutter-y-md">
          <q-tabs v-model="tab" active-color="primary" align="justify">
            <q-tab
              name="dashboard"
              :label="$t('dashboard')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="channels"
              :label="$t('channels')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="transactions"
              :label="$t('transactions')"
              @update="val => tab = val.name"
            ></q-tab>
          </q-tabs>
        </div>
      </div>

      <q-form name="settings_form" id="settings_form">
        <q-tab-panels v-model="tab" animated>
          {% include "node/_tab_dashboard.html" %} {% include
          "node/_tab_channels.html" %} {% include "node/_tab_transactions.html"
          %}
        </q-tab-panels>
      </q-form>
    </q-card>
  </div>
</div>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  Vue.component(VueQrcode.name, VueQrcode)
  Vue.use(VueQrcodeReader)

  {% raw %}
  Vue.component('lnbits-stat',
    {
      props: ['title', 'amount', 'msat', 'btc'],
      computed: {
        value: function () {
          return this.amount ?? (this.btc ? LNbits.utils.formatSat(this.btc) : LNbits.utils.formatMsat(this.msat))
        }
      },
      template: `
          <q-card>
            <q-card-section>
              <div class="text-overline text-primary">
                {{ title }}
              </div>
              <div>
                <span class="text-h4 text-bold q-my-none">{{ value }}</span>
                <span class='text-h5' v-if='msat'>sats</span>
                <span class='text-h5' v-if='btc'>BTC</span>
              </div>
            </q-card-section>
          </q-card>
        `,
    },
  )
  {% endraw %}


  new Vue({
    el: '#vue',
    config: {
      globalProperties: {
        LNbits,
        msg: 'hello'
      }
    },
    mixins: [windowMixin],
    data: function () {
      return {
        isSuperUser: false,
        wallet: {},
        tab: 'dashboard',
        payments: 1000,
        info: {},
        channel_stats: {},
        channels: [],
        ranks: null,

        peers: [],

        connectPeerDialog: {
          show: false,
          data: {}
        },

        openChannelDialog: {
          show: false,
          data: {}
        },
        closeChannelDialog: {
          show: false,
          data: {}
        },

        filteredPayments: [],
        paymentsTable: {
          columns: [
            {
              name: 'memo',
              align: 'left',
              label: this.$t('memo'),
              field: 'memo'
            },
            {
              name: 'date',
              align: 'left',
              label: this.$t('date'),
              field: 'date',
              sortable: true
            },
            {
              name: 'sat',
              align: 'right',
              label: this.$t('amount') + ' (' + LNBITS_DENOMINATION + ')',
              field: 'sat',
              sortable: true
            },
            {
              name: 'fee',
              align: 'right',
              label: this.$t('fee') + ' (m' + LNBITS_DENOMINATION + ')',
              field: 'fee'
            }
          ],
          pagination: {
            rowsPerPage: 10
          },
          filter: null
        }
      }
    },
    created: function () {
      this.getInfo()
      this.get1MLStats()
      this.getPeers()
    },
    watch: {
      tab: function (val) {
        if (val === 'transactions' && !this.filteredPayments.length) {
          this.getPayments()
        } else if(val === 'channels' && !this.channels.length) {
          this.getChannels()
          this.getPeers()
        } else if(val === 'dashboard' && !this.info) {
          this.getInfo()
          this.get1MLStats()
        }
      }
    },
    computed: {
      checkChanges() {
        return !_.isEqual(this.settings, this.formData)
      },
    },
    methods: {
      formatMsat: function (msat) {
        return LNbits.utils.formatMsat(msat)
      },
      api: function (method, url, data) {
        return LNbits.api.request(method, '/node/api/v1' + url + '?usr=' + this.g.user.id, {}, data)
      },

      getChannels: function () {
        LNbits.api
          .request('GET', '/node/api/v1/channels?usr=' + this.g.user.id, {})
          .then(response => {
            this.channels = response.data.channels
            console.log('hi', this.channels)
          })
      },
      getInfo: function () {
        LNbits.api
          .request('GET', '/node/api/v1/info?usr=' + this.g.user.id, {})
          .then(response => {
            this.channels = response.data.channels
            this.info = response.data
            this.channel_stats = response.data.channel_stats
            this.stats = {
              avg_channel_size: LNbits.utils.formatMsat(
                response.data.avg_channel_size,
              ),
              balance: LNbits.utils.formatMsat(response.data.balance_msat),
              total_capacity: LNbits.utils.formatMsat(
                response.data.total_capacity_msat
              ),
              num_channels: response.data.num_channels,
              biggest_channel_size: LNbits.utils.formatMsat(
                response.data.biggest_channel_size
              ),
              smallest_channel_size: LNbits.utils.formatMsat(
                response.data.smallest_channel_size,
              )
            }
          })
      },
      get1MLStats: function () {
        return LNbits.api
          .request('GET', '/node/api/v1/rank?usr=' + this.g.user.id, {})
          .then(response => {
            this.ranks = response.data
          })
      },
      getPayments: function () {
        return LNbits.api
          .request('GET', '/node/api/v1/transactions?usr=' + this.g.user.id, {})
          .then(response => {
            this.filteredPayments = response.data
              .map(obj => {
                return LNbits.map.payment(obj)
              })
              .sort((a, b) => {
                return b.time - a.time
              })
            console.log('payments', this.filteredPayments)
          })
      },
      getPeers: function () {
        return this.api('GET', '/peers')
          .then(response => {
            this.peers = response.data
            console.log('peers', this.peers)
          })
      },
      connectPeer: function () {
        console.log('peer', this.connectPeerDialog)
        LNbits.api.request('POST', '/node/api/v1/peers/connect?usr=' + this.g.user.id, {}, this.connectPeerDialog.data)
          .then(response => {
            this.getPeers()
          })
          .catch(error => {
            console.log(error)
          })
      },
      openChannel: function () {
        this.api('POST', '/channels', this.openChannelDialog.data)
          .then(response => {
            this.openChannelDialog.show = false
            this.getChannels()
          })
          .catch(error => {
            console.log(error)
          })
      },
      showCloseChannelDialog: function (channel) {
        this.closeChannelDialog.show = true,
        this.closeChannelDialog.data= {force: false, short_id: channel.short_id, funding_txid: channel.funding_txid}
      },
      closeChannel: function () {
        this.api('DELETE', '/channels', this.closeChannelDialog.data)
      },
      showOpenChannelDialog: function (peer_id) {
        this.openChannelDialog.show = true
        this.openChannelDialog.data = {peer_id, funding_amount: 0}
      }
    }
  })
</script>

{% endblock %}
