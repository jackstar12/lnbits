{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<div class="row q-col-gutter-md justify-center">
  <div class="col q-gutter-y-md">
    <q-card>
      <div class="q-pa-md">
        <div class="q-gutter-y-md">
          <q-tabs v-model="tab" active-color="primary" align="justify">
            <q-tab
              name="dashboard"
              :label="$t('dashboard')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="channels"
              :label="$t('channels')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="transactions"
              :label="$t('transactions')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="apps"
              :label="$t('apps')"
              @update="val => tab = val.name"
            ></q-tab>
          </q-tabs>
        </div>
      </div>

      <q-form name="settings_form" id="settings_form">
        <q-tab-panels v-model="tab" animated>
          {% include "node/_tab_apps.html" %} {% include
          "node/_tab_channels.html" %} {% include "node/_tab_dashboard.html" %}
          {% include "node/_tab_transactions.html" %}
        </q-tab-panels>
      </q-form>
    </q-card>
  </div>
</div>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  Vue.component(VueQrcode.name, VueQrcode)
  Vue.use(VueQrcodeReader)

  {% raw %}
  Vue.component('lnbits-stat',
    {
      props: ['title', 'amount', 'msat'],
      computed: {
        value: function() {
          return this.amount ?? LNbits.utils.formatMsat(this.msat)
        }
      },
      template: `
        <q-card>
          <q-card-section>
            <div class="text-overline text-primary">
              {{ title }}
            </div>
            <div>
              <span class="text-h2 q-my-none">{{ value }}</span>
              <span class='text-h4' v-if='msat'>sats</span>
            </div>
          </q-card-section>
        </q-card>
      `,

    },
  )
  {% endraw %}


  new Vue({
    el: '#vue',
    config: {
      globalProperties: {
        LNbits,
        msg: 'hello'
      }
    },
    mixins: [windowMixin],
    data: function () {
      return {
        isSuperUser: false,
        wallet: {},
        tab: 'dashboard',
        payments: 1000,
        info: {},
        channel_stats: {},
        channels: [],
        ranks: {},
        filteredPayments: [],
        paymentsTable: {
          columns: [
            {
              name: 'memo',
              align: 'left',
              label: this.$t('memo'),
              field: 'memo'
            },
            {
              name: 'date',
              align: 'left',
              label: this.$t('date'),
              field: 'date',
              sortable: true
            },
            {
              name: 'sat',
              align: 'right',
              label: this.$t('amount') + ' (' + LNBITS_DENOMINATION + ')',
              field: 'sat',
              sortable: true
            },
            {
              name: 'fee',
              align: 'right',
              label: this.$t('fee') + ' (m' + LNBITS_DENOMINATION + ')',
              field: 'fee'
            }
          ],
          pagination: {
            rowsPerPage: 10
          },
          filter: null
        }
      }
    },
    created: function () {
      this.getChannels()
      this.getInfo()
      this.get1MLStats()
      this.getPayments()
    },
    computed: {
      checkChanges() {
        return !_.isEqual(this.settings, this.formData)
      }
    },
    methods: {
      get: function() {

      },
      getChannels: function () {
        LNbits.api
          .request('GET', '/node/api/v1/channels?usr=' + this.g.user.id, {})
          .then(response => {
            this.channels = response.data.channels
            console.log('hi', this.channels)
          })
      },
      getInfo: function () {
        LNbits.api
          .request('GET', '/node/api/v1/info?usr=' + this.g.user.id, {})
          .then(response => {
            this.channels = response.data.channels
            this.info = response.data
            this.channel_stats = response.data.channel_stats
            this.stats = {
              avg_channel_size: LNbits.utils.formatMsat(
                response.data.avg_channel_size,
              ),
              balance: LNbits.utils.formatMsat(response.data.balance_msat),
              total_capacity: LNbits.utils.formatMsat(
                response.data.total_capacity_msat
              ),
              num_channels: response.data.num_channels,
              biggest_channel_size: LNbits.utils.formatMsat(
                response.data.biggest_channel_size
              ),
              smallest_channel_size: LNbits.utils.formatMsat(
                response.data.smallest_channel_size,
              )
            }
          })
      },
      get1MLStats: function () {
        return LNbits.api
          .request('GET', '/node/api/v1/rank?usr=' + this.g.user.id, {})
          .then(response => {
            this.ranks = response.data
          })
      },
      getPayments: function () {
        return LNbits.api
          .request('GET', '/node/api/v1/transactions?usr=' + this.g.user.id, {})
          .then(response => {
            this.filteredPayments = response.data
              .map(obj => {
                return LNbits.map.payment(obj)
              })
              .sort((a, b) => {
                return b.time - a.time
              })
          })
      }
    }
  })
</script>

{% endblock %}
