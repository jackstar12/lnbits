{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<q-dialog v-model="nodeInfoDialog.show">
  <q-card class="my-card">
    <q-card-section>
      <div class="text-h6">
        <div style="text-align: center">
          <qrcode
            value="24a8228d764091fce2ed67e1a7404f83e38ea3c7cb42030a2789e73cf3b341365@84.16.229.1:9735"
            :options="{width: 250}"
            class="rounded-borders"
          ></qrcode>
        </div>
      </div>
    </q-card-section>
    <q-card-actions vertical>
      <q-btn
        dense
        unelevated
        size="md"
        @click="copyText(nodeInfoDialog.data.id)"
        >Public Key<q-tooltip> Click to copy </q-tooltip>
      </q-btn>
      <q-btn
        dense
        unelevated
        size="md"
        @click="copyText(nodeInfoDialog.data.id + '@84.16.229.1:9735')"
        >Node ID<q-tooltip> Click to copy </q-tooltip>
      </q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<div class="row q-col-gutter-md justify-center">
  <div class="col q-gutter-y-md">
    <q-card>
      <div class="q-pa-md">
        <div class="q-gutter-y-md">
          <q-tabs v-model="tab" active-color="primary" align="justify">
            <q-tab
              name="dashboard"
              :label="$t('dashboard')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="channels"
              :label="$t('channels')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="transactions"
              :label="$t('transactions')"
              @update="val => tab = val.name"
            ></q-tab>
          </q-tabs>
        </div>
      </div>

      <q-form name="settings_form" id="settings_form">
        <q-tab-panels v-model="tab" animated>
          {% include "node/_tab_dashboard.html" %} {% include
          "node/_tab_channels.html" %} {% include "node/_tab_transactions.html"
          %}
        </q-tab-panels>
      </q-form>
    </q-card>
  </div>
</div>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  Vue.component(VueQrcode.name, VueQrcode)
  Vue.use(VueQrcodeReader)

  {% raw %}
  Vue.component('lnbits-stat',
    {
      props: ['title', 'amount', 'msat', 'btc'],
      computed: {
        value: function() {
          return this.amount ?? (this.btc ? LNbits.utils.formatSat(this.btc) : LNbits.utils.formatMsat(this.msat))
        }
      },
      template: `
        <q-card>
        <q-card-section>
          <div class='text-overline text-primary'>
            {{ title }}
          </div>
          <div>
            <span class='text-h4 text-bold q-my-none'>{{ value }}</span>
            <span class='text-h5' v-if='msat != undefined'>sats</span>
            <span class='text-h5' v-if='btc != undefined'>BTC</span>
          </div>
        </q-card-section>
        </q-card>
      `
    }
  )


  Vue.component('lnbits-channel-balance',
    {
      props: ['balance', 'color'],
      methods: {
        formatMsat: function(msat) {
          return LNbits.utils.formatMsat(msat)
        }
      },
      template: `
        <div>
                        <div class="row items-center justify-between">
                          <span class="text-weight-thin">
                            Inbound: {{ formatMsat(balance.inbound_msat) }}
                            sats
                          </span>
                          <span class="text-weight-thin">
                            Outbound: {{ formatMsat(balance.outbound_msat) }}
                            sats
                          </span>
                        </div>

                        <q-linear-progress
                          rounded
                          class="q-mb-md"
                          size="25px"
                          :value="balance.inbound_msat / balance.total_msat"
                          :color="color"
                          :style="\`color: #${this.color}\`"
                        >
                          <div class="absolute-full flex flex-center">
                            <q-badge
                              color="white"
                              text-color="accent"
                              :label="formatMsat(balance.total_msat) + ' sats'"
                            >
                              {{ balance.alias }}
                            </q-badge>
                          </div>
                        </q-linear-progress>
        </div>
      `
    }
  )

  Vue.component('lnbits-date',
    {
      props: ['ts'],
      computed: {
        date: function() {
          return Quasar.utils.date.formatDate(
            new Date(this.ts * 1000),
            'YYYY-MM-DD HH:mm'
          )
        },
        dateFrom: function() {
          return moment(this.date).fromNow()
        }
      },
      template: `
        <div>
          <q-tooltip>{{ this.date }}</q-tooltip>
          {{ this.dateFrom }}
        </div>
      `
    }
  )


  Vue.component('lnbits-date',
    {
      props: ['ts'],
      computed: {
        date: function() {
          return Quasar.utils.date.formatDate(
            new Date(this.ts * 1000),
            'YYYY-MM-DD HH:mm'
          )
        },
        dateFrom: function() {
          return moment(this.date).fromNow()
        }
      },
      template: `
        <div>
          <q-tooltip>{{ this.date }}</q-tooltip>
          {{ this.dateFrom }}
        </div>
      `
    }
  )

  {% endraw %}


  new Vue({
    el: '#vue',
    config: {
      globalProperties: {
        LNbits,
        msg: 'hello'
      }
    },
    mixins: [windowMixin],
    data: function() {
      return {
        isSuperUser: false,
        wallet: {},
        tab: 'dashboard',
        payments: 1000,
        info: {},
        channel_stats: {},
        channels: [],
        activeBalance: {},
        ranks: null,

        peers: [],

        connectPeerDialog: {
          show: false,
          data: {}
        },

        openChannelDialog: {
          show: false,
          data: {}
        },

        closeChannelDialog: {
          show: false,
          data: {}
        },

        nodeInfoDialog: {
          show: false,
          data: {}
        },

        states: [
          {label: 'Active', value: 'active'},
          {label: 'Pending', value: 'pending'},
          {label: 'Inactive', value: 'inactive'},
          {label: 'Closed', value: 'closed'}
        ],

        stateFilters: [
          {label: 'Active', value: 'active'},
          {label: 'Pending', value: 'pending'}
        ],

        filteredPayments: [],
        filteredInvoices: [],
        paymentsTable: {
          columns: [
            {
              name: 'pending',
              label: ''
            },
            {
              name: 'memo',
              align: 'left',
              label: this.$t('memo'),
              field: 'memo'
            },
            {
              name: 'date',
              align: 'left',
              label: this.$t('date'),
              field: 'date',
              sortable: true
            },
            {
              name: 'sat',
              align: 'right',
              label: this.$t('amount') + ' (' + LNBITS_DENOMINATION + ')',
              field: row => this.formatMsat(row.amount),
              sortable: true
            },
            {
              name: 'fee',
              align: 'right',
              label: this.$t('fee') + ' (m' + LNBITS_DENOMINATION + ')',
              field: 'fee'
            },
            {
              name: 'destination',
              align: 'right',
              label: 'Destination',
              field: 'destination'
            }
          ],
          pagination: {
            rowsPerPage: 10
          },
          filter: null
        },
        invoiceTable: {
          data: [],
          columns: [
            {
              name: 'pending',
              label: ''
            },
            {
              name: 'memo',
              align: 'left',
              label: this.$t('memo'),
              field: 'memo'
            },
            {
              name: 'paid_at',
              field: 'paid_at',
              align: 'right',
              label: 'Paid at',
              sortable: true
            },
            {
              name: 'expiry',
              label: this.$t('expiry'),
              field: 'expiry',
              align: 'right',
              sortable: true
            },
            {
              name: 'amount',
              label: this.$t('amount') + ' (' + LNBITS_DENOMINATION + ')',
              field: row => this.formatMsat(row.amount),
              sortable: true
            },
          ],
          pagination: {
            rowsPerPage: 10
          },
          filter: null
        }
      }
    },
    created: function() {
      this.getInfo()
      this.get1MLStats()
      this.getPeers()
    },
    watch: {
      tab: function(val) {
        if (val === 'transactions' && !this.filteredPayments.length) {
          this.getPayments()
          this.getInvoices()
        } else if (val === 'channels' && !this.channels.length) {
          this.getChannels()
          this.getPeers()
        } else if (val === 'dashboard' && !this.info) {
          this.getInfo()
          this.get1MLStats()
        }
      }
    },
    computed: {
      checkChanges() {
        return !_.isEqual(this.settings, this.formData)
      },
      filteredChannels: function() {
        return !this.stateFilters ? this.channels : this.channels.filter(channel => {
          return this.stateFilters.find(({value}) => value == channel.state) ? true : false
        })
      }
    },
    methods: {
      formatMsat: function(msat) {
        return LNbits.utils.formatMsat(msat)
      },
      api: function(method, url, data) {
        return LNbits.api.request(method, '/node/api/v1' + url + '?usr=' + this.g.user.id, {}, data)
          .catch(error => {
            LNbits.utils.notifyApiError(error)
          })
      },

      getChannels: function() {
        LNbits.api
          .request('GET', '/node/api/v1/channels?usr=' + this.g.user.id, {})
          .then(response => {
            //this.channels = response.data.by_state.active
            this.channels = response.data.channels
            this.activeBalance = response.data.active_balance
            console.log('hi', this.channels)
          })
      },
      getInfo: function() {
        LNbits.api
          .request('GET', '/node/api/v1/info?usr=' + this.g.user.id, {})
          .then(response => {
            this.info = response.data
            this.channel_stats = response.data.channel_stats
            this.stats = {
              avg_channel_size: LNbits.utils.formatMsat(
                response.data.avg_channel_size
              ),
              balance: LNbits.utils.formatMsat(response.data.balance_msat),
              total_capacity: LNbits.utils.formatMsat(
                response.data.total_capacity_msat
              ),
              num_channels: response.data.num_channels,
              biggest_channel_size: LNbits.utils.formatMsat(
                response.data.biggest_channel_size
              ),
              smallest_channel_size: LNbits.utils.formatMsat(
                response.data.smallest_channel_size
              )
            }
          })
      },
      get1MLStats: function() {
        return LNbits.api
          .request('GET', '/node/api/v1/rank?usr=' + this.g.user.id, {})
          .then(response => {
            this.ranks = response.data
          })
      },
      getPayments: function() {
        return this.api('GET', '/payments')
          .then(response => {
            this.filteredPayments = response.data
              .map(obj => {
                return LNbits.map.payment(obj)
              })
              .sort((a, b) => {
                return b.time - a.time
              })
            console.log('payments', this.filteredPayments)
          })
      },
      getInvoices: function() {
        return this.api('GET', '/invoices')
          .then(response => {
            this.filteredInvoices = response.data
            this.invoiceTable.data = response.data
            console.log('payments', this.filteredPayments)
          })
      },
      getPeers: function() {
        return this.api('GET', '/peers')
          .then(response => {
            this.peers = response.data
            console.log('peers', this.peers)
          })
      },
      connectPeer: function() {
        console.log('peer', this.connectPeerDialog)
        this.api('POST', '/peers/connect', this.connectPeerDialog.data)
          .then(() => {
            this.connectPeerDialog.show = false
            this.getPeers()
          })
      },
      openChannel: function() {
        this.api('POST', '/channels', this.openChannelDialog.data)
          .then(response => {
            this.openChannelDialog.show = false
            this.getChannels()
          })
          .catch(error => {
            console.log(error)
          })
      },
      showCloseChannelDialog: function(channel) {
        this.closeChannelDialog.show = true,
          this.closeChannelDialog.data = {force: false, short_id: channel.short_id, funding_txid: channel.funding_txid}
      },
      closeChannel: function() {
        this.api('DELETE', '/channels', this.closeChannelDialog.data)
          .then(response => {
            this.closeChannelDialog.show = false
            this.getChannels()
          })
      },
      showOpenChannelDialog: function(peer_id) {
        this.openChannelDialog.show = true
        this.openChannelDialog.data = {peer_id, funding_amount: 0}
      },
      showNodeInfoDialog: function(node) {
        this.nodeInfoDialog.show = true
        this.nodeInfoDialog.data = node
      },
      shortenNodeId: function(node_id) {
        return node_id.substring(0, 5) + '...' + node_id.substring(node_id.length - 5)
      },
    }
  })



</script>

{% endblock %}
